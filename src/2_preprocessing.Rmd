# Resultaten van de dataverkenning


```{r}

# details per provincie
overzicht_bezoeken_tellers_provincie_locatie_detail <- tellers_provincies %>%
  filter(jaar >= 2016) %>%
  group_by(soortgroep, meetnet, jaar, provincie_locatie) %>%
  summarise(n_tellers = n_distinct(naam_teller),
            n_tellingen = n_distinct(visit_id),
            n_telgebieden = n_distinct(locatie)) %>%
  ungroup() %>% 
  select(provincie_locatie, everything()) %>%
  arrange(provincie_locatie, soortgroep, meetnet, jaar)

#write.csv2(overzicht_bezoeken_tellers_provincie_locatie_detail, "../output/overzicht_tellingen_meetnet_provincielocatie.csv")

overzicht_bezoeken_tellers_provincie_teller_detail <- tellers_provincies %>%
  filter(jaar >= 2016) %>%
  group_by(soortgroep, meetnet, jaar, provincie_teller) %>%
  summarise(n_tellers = n_distinct(naam_teller),
            n_tellingen = n_distinct(visit_id),
            n_telgebieden = n_distinct(locatie)) %>%
  ungroup() %>% 
  select(provincie_teller, everything()) %>%
  arrange(provincie_teller, soortgroep, meetnet, jaar)

#write.csv2(overzicht_bezoeken_tellers_provincie_teller_detail, "../output/overzicht_tellingen_meetnet_provincieteller.csv")

overzicht_bezoeken_tellers_provincie_locatie <- tellers_provincies %>%
  filter(jaar >= 2016) %>%
  group_by(soortgroep, jaar, provincie_locatie) %>%
  summarise(n_tellers = n_distinct(naam_teller),
            n_tellingen = n_distinct(visit_id),
            n_telgebieden = n_distinct(locatie)) %>%
  ungroup() %>% 
  select(provincie_locatie, everything()) %>%
  arrange(provincie_locatie, soortgroep,  jaar)

#write.csv2(overzicht_bezoeken_tellers_provincie_locatie, "../output/overzicht_tellingen_soortgroep_provincielocatie.csv")

overzicht_bezoeken_tellers_provincie_teller <- tellers_provincies %>%
  filter(jaar >= 2016) %>%
  group_by(soortgroep,  jaar, provincie_teller) %>%
  summarise(n_tellers = n_distinct(naam_teller),
            n_tellingen = n_distinct(visit_id),
            n_telgebieden = n_distinct(locatie)) %>%
  ungroup() %>% 
  select(provincie_teller, everything()) %>%
  arrange(provincie_teller, soortgroep, jaar)

#write.csv2(overzicht_bezoeken_tellers_provincie_teller, "../output/overzicht_tellingen_soortgroep_provincieteller.csv")

overzicht_provincieteller <- tellers_provincies %>%
  filter(jaar >= 2016) %>%
  group_by(provincie_teller) %>%
  summarise(n_tellers = n_distinct(naam_teller),
            n_telgebieden = n_distinct(locatie)) %>%
  ungroup() %>% 
  select(provincie_teller, everything()) %>%
  arrange(provincie_teller)

#write.csv2(overzicht_provincieteller, "../output/overzicht_provincieteller.csv", row.names = FALSE, na = "")

overzicht_provincielocatie <- tellers_provincies %>%
  filter(jaar >= 2016) %>%
  group_by(provincie_locatie) %>%
  summarise(n_tellers = n_distinct(naam_teller),
            n_telgebieden = n_distinct(locatie)) %>%
  ungroup() %>% 
  select(provincie_locatie, everything()) %>%
  arrange(provincie_locatie)

#write.csv2(overzicht_provincielocatie, "../output/overzicht_provincielocatie.csv", row.names = FALSE, na = "")

overzicht_provincielocatie_provincieteller <- tellers_provincies %>%
  filter(jaar >= 2016) %>%
  group_by(provincie_locatie, provincie_teller) %>%
  summarise(n_tellers = n_distinct(naam_teller),
            n_telgebieden = n_distinct(locatie)) %>%
  ungroup() %>% 
  select(provincie_locatie, provincie_teller, everything()) %>%
  arrange(provincie_locatie)
```



```{r monitoringsinspanning}

overzicht_bezoeken <- bezoeken %>%
  group_by(soortgroep, meetnet, jaar) %>%
  summarise(n_tellingen = n_distinct(visit_id)) %>%
  ungroup()

overzicht_locaties <- bezoeken %>%
  group_by(soortgroep, meetnet, jaar) %>%
  summarise(n_telgebieden = n_distinct(locatie)) %>%
  ungroup()

overzicht_tellers <- tellers %>%
  group_by(soortgroep, meetnet, jaar) %>%
  summarise(n_tellers = n_distinct(naam_teller)) %>%
  ungroup()

# overzicht_bezoeken_tellers <- tellers %>%
#   filter(jaar >= 2016) %>%
#   group_by(soortgroep, meetnet, jaar) %>%
#   summarise(n_tellers = n_distinct(naam_teller),
#             n_tellingen = n_distinct(visit_id),
#             n_telgebieden = n_distinct(locatie)) %>%
#   ungroup()

overzicht_bezoeken_tellers <- bind_rows(
  overzicht_bezoeken %>%
    filter(jaar >= 2016) %>%
    spread(key = jaar, value = n_tellingen) %>%
    mutate(monitoringsinspanning = "aantal tellingen"),
  overzicht_locaties %>%
    filter(jaar >= 2016) %>%
    spread(key = jaar, value = n_telgebieden) %>%
    mutate(monitoringsinspanning = "aantal tellocaties"),
  overzicht_tellers %>%
    filter(jaar >= 2016) %>%
    spread(key = jaar, value = n_tellers) %>%
    mutate(monitoringsinspanning = "aantal tellers")
  ) %>%
  arrange(soortgroep, meetnet) %>%
  select(soortgroep, meetnet, monitoringsinspanning, everything())
  

overzicht_bezoeken_tellers_long <- bind_rows(
  overzicht_bezoeken %>%
    filter(jaar >= 2016) %>%
    rename(aantal = n_tellingen) %>%
    mutate(monitoringsinspanning = "aantal tellingen"),
  overzicht_locaties %>%
    filter(jaar >= 2016) %>%
    rename(aantal = n_telgebieden) %>%
    mutate(monitoringsinspanning = "aantal tellocaties"),
  overzicht_tellers %>%
    filter(jaar >= 2016) %>%
    rename(aantal = n_tellers) %>%
    mutate(monitoringsinspanning = "aantal tellers")
  ) %>%
  arrange(soortgroep, meetnet) %>%
  select(soortgroep, meetnet, monitoringsinspanning, everything())

# write.csv2(overzicht_bezoeken_tellers,
#            str_c("../output/monitoringsinspanning_", versie, ".csv"))

```


```{r monitoringsinspanning totaal}

overzicht_bezoeken <- bezoeken %>%
  group_by(jaar) %>%
  summarise(n_tellingen = n_distinct(visit_id)) %>%
  ungroup()

overzicht_locaties <- bezoeken %>%
  group_by(jaar) %>%
  summarise(n_telgebieden = n_distinct(locatie)) %>%
  ungroup()

overzicht_tellers <- tellers %>%
  group_by(jaar) %>%
  summarise(n_tellers = n_distinct(naam_teller)) %>%
  ungroup()

overzicht_bezoeken_tellers_totaal <- bind_rows(
  overzicht_bezoeken %>%
    filter(jaar >= 2016) %>%
    spread(key = jaar, value = n_tellingen) %>%
    mutate(monitoringsinspanning = "aantal tellingen"),
  overzicht_locaties %>%
    filter(jaar >= 2016) %>%
    spread(key = jaar, value = n_telgebieden) %>%
    mutate(monitoringsinspanning = "aantal tellocaties"),
  overzicht_tellers %>%
    filter(jaar >= 2016) %>%
    spread(key = jaar, value = n_tellers) %>%
    mutate(monitoringsinspanning = "aantal tellers")
  ) 
  
write.csv2(overzicht_bezoeken_tellers, "../output/overzicht_bezoeken_tellers.csv", row.names = FALSE)


overzicht_bezoeken_tellers_totaal_long <- bind_rows(
  overzicht_bezoeken %>%
    filter(jaar >= 2016) %>%
    rename(aantal = n_tellingen) %>%
    mutate(monitoringsinspanning = "aantal tellingen"),
  overzicht_locaties %>%
    filter(jaar >= 2016) %>%
    rename(aantal = n_telgebieden) %>%
    mutate(monitoringsinspanning = "aantal tellocaties"),
  overzicht_tellers %>%
    filter(jaar >= 2016) %>%
    rename(aantal = n_tellers) %>%
    mutate(monitoringsinspanning = "aantal tellers")
  ) %>%
  arrange(jaar) %>%
  select(monitoringsinspanning, everything())

write.csv2(overzicht_bezoeken_tellers_long,
           str_c("../output/monitoringsinspanning_", versie, ".csv"), row.names = FALSE)

```


```{r aantallenMeetnet}

aantallen_bezoek_detail <- aantallen %>%
  group_by(soortgroep, meetnet, protocol, locatie, visit_id, jaar, datum, soort_nl, soort_wet, primaire_soort, geslacht, activiteit, levensstadium) %>%
  summarise(aantal = sum(aantal, na.rm = TRUE),
            n_subsamples = n()) %>%
  ungroup() %>%
  mutate(geslacht = ifelse(geslacht == "M", "mannelijk", 
                           ifelse(geslacht == "F", "vrouwelijk", "onbekend")))

overzicht_aantallen_primair_detail <- aantallen_bezoek_detail %>%
  filter(primaire_soort) %>%
  group_by(soortgroep, meetnet, jaar, soort_nl, soort_wet, geslacht, activiteit, levensstadium) %>%
  summarise(totaal = sum(aantal),
            gemiddeld = round(mean(aantal),1),
            maximum = max(aantal),
            bezoeken = n()) %>%
  ungroup()
  
overzicht_aantallen_primair_detail_wide <- overzicht_aantallen_primair_detail %>%
  select(-bezoeken) %>%
  gather(totaal, gemiddeld, maximum, key = "aantal", value = "waarde") %>%
  spread(key = "jaar", value = "waarde")

overzicht_aantallen_levensstadium_primair <- aantallen_levensstadium %>%
  group_by(soortgroep, meetnet, protocol, locatie, visit_id, jaar, datum, soort_nl, soort_wet, primaire_soort, levensstadium) %>%
  summarise(aantal = sum(aantal, na.rm = TRUE),
            n_subsamples = n()) %>%
  ungroup() %>%
  filter(primaire_soort) %>%
  group_by(soortgroep, meetnet, jaar, soort_nl, soort_wet,levensstadium) %>%
  summarise(totaal = sum(aantal),
            gemiddeld = round(mean(aantal),1),
            maximum = max(aantal),
            bezoeken = n()) %>%
  ungroup()
  
overzicht_aantallen_levensstadium_primair_wide <- overzicht_aantallen_levensstadium_primair %>%
  select(-bezoeken) %>%
  gather(totaal, gemiddeld, maximum, key = "aantal", value = "waarde") %>%
  spread(key = "jaar", value = "waarde")

overzicht_aantallen_detail_overige <- aantallen_bezoek_detail %>%
  filter(!primaire_soort) %>%
  group_by(soortgroep, jaar, soort_nl, soort_wet, geslacht, activiteit, levensstadium) %>%
  summarise(totaal = sum(aantal)) %>%
  ungroup() %>%
  filter(totaal != 0)
  
overzicht_aantallen_detail_overige_wide <- overzicht_aantallen_detail_overige %>%
  spread(key = "jaar", value = "totaal", fill = 0)

overzicht_aantallen_levensstadium_overige <-  aantallen_levensstadium %>%
  group_by(soortgroep, meetnet, protocol, locatie, visit_id, jaar, datum, soort_nl, soort_wet, primaire_soort, levensstadium) %>%
  summarise(aantal = sum(aantal, na.rm = TRUE),
            n_subsamples = n()) %>%
  ungroup() %>%
  filter(!primaire_soort) %>%
  group_by(soortgroep, jaar, soort_nl, soort_wet, levensstadium) %>%
  summarise(totaal = sum(aantal)) %>%
  ungroup() %>%
  filter(totaal != 0)
  
overzicht_aantallen_levensstadium_overige_wide <- overzicht_aantallen_levensstadium_overige %>%
  spread(key = "jaar", value = "totaal", fill = 0)

# write.csv2(overzicht_aantallen_levensstadium_primair_wide,
#            str_c("../output/aantallen_primair_", versie, ".csv"),
#            row.names = FALSE)
# 
# write.csv2(overzicht_aantallen_levensstadium_overige_wide,
#            str_c("../output/aantallen_overige_", versie, ".csv"),
#            row.names = FALSE)

```

```{r}
aantallen_bezoek_levensstadium <- aantallen_levensstadium %>%
  group_by(soortgroep, meetnet, protocol, locatie, visit_id, jaar, datum, doy, soort_nl, soort_wet, primaire_soort, levensstadium) %>%
  summarise(aantal = sum(aantal, na.rm = TRUE),
            n_subsamples = n(),
            maximum = max(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(soort_stadium = str_c(soort_nl, levensstadium, sep = " "),
         jaar = as.character(jaar))


aantallen_bezoek_totaal <- aantallen_levensstadium %>%
  group_by(soortgroep, meetnet, protocol, locatie, visit_id, jaar, datum, doy, soort_nl, soort_wet, primaire_soort) %>%
  summarise(aantal = sum(aantal, na.rm = TRUE),
            maximum = max(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(jaar = as.character(jaar))
  
  
```

## Overzichtstabellen

Op basis van deze gegevens geven we per soortengroep een overzicht van:

* monitoringsinspanning uitgedrukt in aantal tellingen en aantal tellers

* totaal, gemiddeld en maximum getelde aantallen voor de primaire soorten

*  totaal getelde aantallen voor de overige soorten

## Figuren

Daarnaast vind je op deze website per meetnet een aantal figuren met de getelde aantallen per bezoek. 

We tonen steeds een figuur met het gemiddeld aantal getelde individuen per jaar (rode bollen) en het 95%-betrouwbaarheidsinterval hierop (rode verticale strepen). Op basis hiervan kan het gemiddelde van de getelde aantallen tussen verschillende jaren vergeleken worden. We tonen als voorbeeld een figuur met de gemiddeldes voor de Boomkikker.      

```{r voorbeeldfiguur3, fig.height= 3, fig.width= 7}

soort <- "Boomkikker"

aantallen_soort_stadium <- aantallen_bezoek_levensstadium %>%
   filter(primaire_soort) %>%
   filter(meetnet == soort) 

max_soort_stadium <- max(aantallen_soort_stadium$aantal) * 1.2

aantallen_soort_stadium %>%
  ggplot(aes(x= jaar, y = aantal)) +  
  #geom_point(alpha = 0.6, colour = inbo.grijs) +
  stat_summary(fun.data = "mean_cl_boot", colour = INBOred, size = 1, alpha = 0.8) +
  facet_wrap(~ soort_stadium, scale = "free_y") +
  labs(y = "Aantal getelde individuen", x = "Jaar") +
  ylim(c(0,NA)) +
  theme(legend.position = "bottom") 

```

Een tweede figuur geeft de evolutie van de getelde aantallen binnen het seizoen weer en dit voor elk jaar waarin er geteld werd. Onderstaand voorbeeld toont het getelde aantal Boomkikker adulten. De stippelijnen verbinden tellingen van eenzelfde locatie. Op basis hiervan krijg je een idee hoe de getelde aantallen binnen een telseizoen variëren.     

```{r voorbeeldfiguur1, message=FALSE, warning= FALSE, fig.width= 8, fig.height= 3}

soort <- "Boomkikker"
stadium <- "adult"

aantallen_soort_stadium <- aantallen_bezoek_levensstadium %>%
   filter(primaire_soort) %>%
   filter(meetnet == soort & levensstadium == stadium ) %>%
   mutate(doy_date = as.Date(doy, origin = "2016-01-01"))

max_soort_stadium <- max(aantallen_soort_stadium$aantal) * 1.2

 p <- aantallen_soort_stadium %>%
  ggplot(aes(x = doy_date, 
             y = aantal,
             group= locatie, 
             colour = locatie)) + 
  geom_point(alpha = 0.6) +  
 geom_line(linetype = 2,  alpha = 0.6, size = 0.4, colour = inbo.grijsblauw)  + 
  facet_grid(soort_stadium ~ jaar) +
  labs(x = "Datum bezoek", y = "Aantal getelde adulten") + 
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  ylim(0, max_soort_stadium) + 
  theme(legend.position = 'none', axis.text.x = element_text(angle = 90))
  p #ggplotly(p) 
```

Indien er veel tellocaties zijn, is het moeilijk om nog een patroon te herkennen in bovenstaande figuur. Daarom tonen we ook onderstaande figuur waarin de blauwe lijn de gemiddelde evolutie toont binnen het telseizoen en de grijze banden aan beide kanten van de blauwe lijn de onzekerheid aangeven op deze gemiddelde evolutie. Een dergelijke figuur vraagt een minimum aantal telgegevens en daarom is het niet mogelijk om deze figuur voor alle soorten te maken.  

```{r voorbeeldfiguur2, message=FALSE, warning= FALSE, fig.width= 8, fig.height= 3}

 q <- aantallen_soort_stadium %>%
  ggplot(aes(x = doy_date, 
             y = aantal, 
 #            size = aantalSectiesGeteld, 
             colour = locatie)) + 
  geom_point(alpha = 0.6) + 
  geom_smooth(method = "gam", method.args = list(family = poisson),formula = y ~ s(x, bs = "cs", k = 5) , size = 0.4, colour = "blue") +
  facet_grid(soort_stadium ~ jaar) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
   labs(x = "Datum bezoek", y = "Aantal getelde adulten") + 
  ylim(0, max_soort_stadium) + 
  theme(legend.position = 'none', axis.text.x = element_text(angle = 90)) 
 q #ggplotly(q)
 
```





